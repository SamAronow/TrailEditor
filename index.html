<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Trail-Editor</title>
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
</head>
<link rel="icon" type="image/png" href="TCTLOGO.png" sizes="32x32" />


<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>-
<script src="https://unpkg.com/mapbox-gl@latest/dist/mapbox-gl.js"></script>
<link rel="stylesheet" href="styling.css">
<script src='https://api.tiles.mapbox.com/mapbox.js/plugins/turf/v3.0.11/turf.min.js'></script>
<script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.0.9/mapbox-gl-draw.js'></script>






<script src = "allgeo.js"></script>
<script src = "Algo.js"></script>
<script src = "MapFunctions.js"></script>

</head>
<body>
    <div id="map"></div>
    <pre id="showWhere"></pre>
      <pre id="lastPoint"></pre>
      <pre id="lastClick"></pre>
        <div id = "commands">
        <select id = file onchange = "addFilePopUp()"> 
            <option value = "temp">keezer</option>
            <option value="create">Add GEOJSON</option>
        </select>
        <label for="dist">Distance Threshold (ft):</label>
        <input type="text" id="distance" name="distance"> 
        <label for="angle">Angle Threshold:</label>
        <input type="text" id="angle" name="angle"> 
        <label for="translationX">translationX (ft):</label>
        <input type="text" id="translationX" name="translationX"> 
        <label for="translationY">translationY (ft):</label>
        <input type="text" id="translationY" name="translationY"> 
        <label for="color">Color:</label>
        <select id = "color"> 
            <option value = "red">Red</option>
            <option value = "orange">Orange</option>
            <option value = "green">Green</option>
            <option value = "blue">Blue</option>
            <option value = "purple">Purple</option>
            <option value = "black">Black</option>
        </select>
        <!-- <input type="text" id="color" name="color">-->
        <button onclick="createNew()">Create New</button>
        <table id = "datatable">
            <tr>
              <th>Filter %</th>
              <th>File</th>
              <th>Distance</th>
              <th>Angle</th>
              <th>Translation(X/Y)</th>
              <th>Length</th>
              <th>Toggle</th>
              <th>Remove</th>
              <th>Copy</th>
              <th>Select</th>
              
            </tr>
          </table> 
    <div id="error-message"></div>
    <div id="popupContainer" class="popup-container">
        <div class="popup">
          <h2>Create a new GEOJSON:</h2>
            <label>Enter Name:</label>
            <input type="text" id="geoName" name="geoName">
            <br><br>
            <label>Enter GEOJSON Data</label>
            <textarea id="enterGeo" name="enterGeo"></textarea>
          <div class="buttons">
            <button class="close-button" id ="closePreview" onclick = "cancelFilePopup()">&times;</button>
            <button id = "submit" onclick="submitFilePopup()">Submit</button>
          </div>
        </div>
      </div>
      <div id="infoPopup">
        <button class="close-button" id ="versionsInfo" onclick = "toggleTutorial()">&times;</button>
        <div id="popupContent">
          <p>Use this to modify trails. Use the distance and angle thresholds to modify the trails such that for every 
            coordinate in the trail, if it is closer than your distance threshold (in degrees of latitude and longitude) 
            and the angle formed by the point and the one before and after is greater than the angle threshold (in radians)
            then it will eliminate the point to clean up the trail. Additionaly the value in translation X and Y will translate
            the trail that many degrees of latitude or longitude. You can add trails using the drop down at the top and selecting 
            add GeoJSON and then inputting your own geojson which will then add a baseline version of it in Blue. Then to modify
            different geoJSONS you can toggle them in the dropdown and you can edit toggle or remove any trail modifications 
            using the table, or click copy to copy a geoJSON of the modification to your clipboard.
          </p>
        </div>
      </div>
      <label id="infoButton" onclick="toggleTutorial()">Tutorial</label>
    </div>
    <div id="clickTogglePopup">
          <button id = "multiSelect" onclick = "multiSelect()">Multi-Select</button>
          <button id = "move" onclick = "move()">Move</button> 
          <button id = "moveSelect" onclick = "moveSelect()">Select</button>
          <button id = "moveMove" onclick = "moveMove()">Move</button>
          <button id = "singleSelect" onclick = "singleClick()">Single-Select</button>
          <button id = "nothing" onclick = "showClick()">Show Point</button>
          <button id = "merge" onclick = "merge()" >Merge</button>
          <button id = "add" onclick = "add()" >Add</button>
          <button id = "addSelect" onclick = "addSelect()">Select</button>
          <button id = "addAdd" onclick = "addAdd()">Add</button>
          <button id = "addTag" onclick = "addTag()">Tag</button>
    </div>
    <button id = "clickToggle" onclick = "promptClickToggle()">Menu</button>
    <button id = "undo" onclick = "openHistory()">Undo</button>
    <button id = "removeAll" onclick = "removeAllSelectedPoints()">Remove Selected</button>
    <button id = "addEnd" onclick = "addEnd()">Current: Add After</button>
    <div class = "scrollable-div" id = showVersions>
      <table id = "versionsTable">
        <tr>
          <th>
            Versions:
          </th>
        </tr>
      </table>
      <button class="close-button" id ="versionsClose" onclick = "closeHistory()">&times;</button>
    </div>
    <div id="tagPopupContainer" class="popup-container">
      <div class="popup" id ="tagPopup">
        <div>Enter Tag:</div>
        <input type="text" id="tagEnter" name="tagEnter">
      <button class="close-button" id ="closePreview" onclick = "closeTag()">&times;</button>
        </div>
        </div>
    <div id="versionPopupContainer" class="popup-container">
      <div class="popup" id ="previewPopup">
        <div id = "versionNumber">
      </div>
        <div id="nestedMap">        
      </div>
      <button id = "restore" onclick="restore()">Restore</button>
      <button id = "back" onclick="back()">Back</button>
      <button id = "next" onclick="next()">Next</button>
      <button class="close-button" id ="closePreview" onclick = "closePreview()">&times;</button>
        </div>
<script>



  //import mapboxgl from 'mapbox-gl';

//set up the mapbox map
mapboxgl.accessToken = 'pk.eyJ1Ijoic2FtYXJudyIsImEiOiJjbGl1c2F1dDAwOW02M3BueTJwdDViNHY4In0.5F8W4nYLQk7H0xjRONCGkw';
const map = new mapboxgl.Map({
    container: 'map', // container ID
    // Choose from Mapbox's core styles, or make your own style with Mapbox Studio
    style: 'mapbox://styles/mapbox/streets-v12', // style URL
    center: [-70.053, 41.9897], // starting position [lng, lat]
    zoom: 18 // starting zoom
});




//put the table and the text fields above the map so they're visible

document.getElementById('commands').style.zIndex = '1';
document.getElementById('error-message').style.zIndex = '1103';
document.getElementById('showWhere').style.zIndex = '1';
document.getElementById('lastClick').style.zIndex = '1';
document.getElementById('lastPoint').style.zIndex = '1';


//give the keezer dropdown option the value of the keezer geojson
var dropdown = document.getElementById("file");
dropdown.options[0].value = JSON.stringify(keezer);

function handleArrowKeys(event) {
      if (event.key === 'ArrowUp' || event.key === 'ArrowRight') {
        console.log(tagStates)
        if (document.getElementById("versionPopupContainer").style.display == 'block'){
            if (undoIndex+2==states[selectedIndex].length){
              printError("At latest version already")
              return;
            }
            undoIndex++;
            reshowPreview()
        }
      } 
      else if (event.key === 'ArrowDown' || event.key === 'ArrowLeft') {
        if (document.getElementById("versionPopupContainer").style.display == 'block'){
          if (undoIndex==0){
            printError("At first version already")
              return;
            }
            undoIndex--;
            reshowPreview()
      }
    }
  }

  function back(){
    if (undoIndex==0){
            printError("At first version already")
              return;
            }
            undoIndex--;
            reshowPreview()
  }

  function next(){
    if (undoIndex+2==states[selectedIndex].length){
              printError("At latest version already")
              return;
            }
            undoIndex++;
            reshowPreview()
  }

    // Add an event listener for the 'keydown' event on the document
    document.addEventListener('keydown', handleArrowKeys);

    document.addEventListener('keydown', handleEnter);
    function handleEnter(){
      if (event.key== 'Enter'){
if (document.getElementById("tagPopupContainer").style.display != 'none'){
        document.getElementById("tagPopupContainer").style.display = 'none'
        tags[selectedIndex].push([tagPoint,document.getElementById("tagEnter").value])
        tagStates[selectedIndex][tagStates[selectedIndex].length-1].push([tagPoint,document.getElementById("tagEnter").value])
      }
      }
      
    }
    



//initiate the map once its loaded
map.on('load', function() {
  
    setUpTrails(map);
    selected = layers[0];
    selectedIndex=0;
}
);

//method to show the location of the mouse
map.on('mousemove', (e) => {
  const lng = e.lngLat.lng.toFixed(6); // Round the longitude to 6 decimal places
  const lat = e.lngLat.lat.toFixed(6); // Round the latitude to 6 decimal places
  document.getElementById('showWhere').innerHTML = `Mouse : {${lng}, ${lat}}`;
});

map.on('drag', () => {
  removeShowPoint(map)
});

map.on('wheel', () => {
  removeShowPoint(map)
});


var tagPoint;
//tells the map how to handle a click
map.on('click', function(e){
  if (selected==null){
    return
  }
  if (document.getElementById('datatable').rows[selectedIndex+1].cells[6].textContent=="Show"){
    return;
  }
  



  var x = round(map.unproject(e.point).lng,6);
 var y = round(map.unproject(e.point).lat,6);
 var point = [round(map.unproject(e.point).lng,6),round(map.unproject(e.point).lat,6)];
 document.getElementById('lastClick').innerHTML = `Click: {${point[0]}, ${point[1]}}`;
 var closest = findClosestPoint(selected.source.data.geometry.coordinates,point);
 

  //For a single-Select mode click
  if (clickOption==0){
    if (closest==null){
  return;
 }
  if (selected==null){
    return;
  }
  
 //get the selected layer and find the closest point to where the click was and remove it
  
  removePoint(closest,"red");
  editPercentage()
  editLength()
  addState();
  }

//for a multi-select mode click
if (clickOption ==1){
  if (closest==null){
  return;
 }
  var i = get2DIndex(layers[selectedIndex].source.data.geometry.coordinates,closest)
  if (selectedPoints.indexOf(closest)>-1){
    map.setPaintProperty(closest[0]+","+closest[1]+","+i, 'circle-radius', [
                  'interpolate',
                  ['linear'],
                  ['zoom'],
                  15, .5, 
                  16, 1,
                  17.5,2.5
                ]);
    selectedPoints.splice(selectedPoints.indexOf(closest),1)
  }
  else{
     map.setPaintProperty(closest[0]+","+closest[1]+","+i, 'circle-radius', 4);
  selectedPoints.push(closest);
  }
 
}


//for a move click
if (clickOption ==2){
  if (moveOption ==1){
    for (var j=0; j<window.tags[window.selectedIndex].length;j++){
            if (window.tags[window.selectedIndex][j][0]==movePoint){
                window.tags[window.selectedIndex][j][0]= point;
            }
          }
    var coords = new Array(0);
       for (var i=0; i<selected.source.data.geometry.coordinates.length; i++){
        coords.push(selected.source.data.geometry.coordinates[i])
       }
      removeAllPoints(coords,map);
      coords.splice(coords.indexOf(movePoint),1,point);
      layers[selectedIndex].source.data.geometry.coordinates = coords;
      selected = layers[selectedIndex];
      map.removeLayer(selected.id);
      map.removeSource(selected.id);  
      map.addLayer(selected); 
      addAllPoints(coords,map);
      moveOption =0;
      document.getElementById("moveSelect").style.backgroundColor = "gray";
      document.getElementById("moveMove").style.backgroundColor = 'rgb(233, 233, 237)';
      movePoint = null;
      map.getCanvas().style.cursor = 'pointer';
      console.log(tagStates)
      addState();
      console.log(tagStates)

  }
  else{
    if (closest==null){
  return;
 }
    if (movePoint ==closest){
      removeMovePoint(map)
      movePoint = null;
      return;
    }
    else{
      removeMovePoint(map)
      var i = get2DIndex(layers[selectedIndex].source.data.geometry.coordinates,closest)
      map.setPaintProperty(closest[0]+","+closest[1]+","+i, 'circle-radius', 4);
      movePoint = closest;
    }
    moveOption =1;
    document.getElementById("moveSelect").style.backgroundColor = 'rgb(233, 233, 237)';
      document.getElementById("moveMove").style.backgroundColor = "gray";
      map.getCanvas().style.cursor = 'crosshair';
  }

}

//for merge
if (clickOption==3){
  if (selectedPoints.length<2){
    if (closest==null){
  return;
 }
    if (get2DIndex(selectedPoints,closest)==-1){
      selectedPoints.push(closest);
    var i = get2DIndex(selected.source.data.geometry.coordinates,closest)
    map.setPaintProperty(closest[0]+","+closest[1]+","+i, 'circle-radius', 4);
    }
    else{
      selectedPoints.splice(get2DIndex(selectedPoints,closest),1)
      var i = get2DIndex(selected.source.data.geometry.coordinates,closest)
      map.setPaintProperty(closest[0]+","+closest[1]+","+i, 'circle-radius', [
                      'interpolate',
                      ['linear'],
                      ['zoom'],
                      15, .5, 
                      16, 1,
                      17.5,2.5
                    ]);
    }
  }
  else{
    removeAllPoints(layers[selectedIndex].source.data.geometry.coordinates,map)
    var coords = new Array(0);
       for (var i=0; i<layers[selectedIndex].source.data.geometry.coordinates.length; i++){
        coords.push(layers[selectedIndex].source.data.geometry.coordinates[i])
       }
    var i =get2DIndex(coords,selectedPoints[0])
    var j = get2DIndex(coords,selectedPoints[1])
    selectedPoints = new Array(0)
    for (var k=0; k<window.tags[window.selectedIndex].length;k++){
            if (window.tags[window.selectedIndex][k][0]==coords[i] || window.tags[window.selectedIndex][k][0]==coords[j]){
                window.tags[window.selectedIndex][k][0]= point;
            }
          }
    if (Math.abs(i-j)<2){
      coords.splice(i,1,point)
    coords.splice(j,1)
}
else{
  coords.splice(i,1,point)
    coords.splice(j,1,point)
}

selected.source.data.geometry.coordinates = coords;
    
    map.removeLayer(selected.id)
    map.removeSource(selected.id)
    map.addLayer(selected)
    layers[selectedIndex] = selected;
    addAllPoints(coords,map)
    addState();

  }
}

//for add
if (clickOption ==5){
  if (addOption ==1){
    var coords = new Array(0);
       for (var i=0; i<selected.source.data.geometry.coordinates.length; i++){
        coords.push(selected.source.data.geometry.coordinates[i])
       }
      removeAllPoints(coords,map);
      if (document.getElementById("addEnd").textContent == "Current: Add After"){
        coords.splice(coords.indexOf(addBeforePoint)+1,0,point);
      }
      else{
       coords.splice(coords.indexOf(addBeforePoint),0,point);
      }
      layers[selectedIndex].source.data.geometry.coordinates =coords;
      selected = layers[selectedIndex];
      map.removeLayer(selected.id);
      map.removeSource(selected.id);  
      map.addLayer(selected); 
      addAllPoints(coords,map);
      addOption =0;
      document.getElementById("addSelect").style.backgroundColor = "gray";
      document.getElementById("addAdd").style.backgroundColor = 'rgb(233, 233, 237)';
      addBeforePoint = null;
      addState();
  }
  else{
    if (closest==null){
  return;
 }
    if (addBeforePoint ==closest){
      removeAddBeforePoint(map)
      return;
    }
    else{
      removeAddBeforePoint(map)
      var i = get2DIndex(layers[selectedIndex].source.data.geometry.coordinates,closest)
      map.setPaintProperty(closest[0]+","+closest[1]+","+i, 'circle-radius', 4);
      addBeforePoint = closest;
    }
    addOption =1;
    document.getElementById("addSelect").style.backgroundColor = 'rgb(233, 233, 237)';
      document.getElementById("addAdd").style.backgroundColor = "gray";
  }
}

//for show point
if (clickOption ==4){
  if (closest==null){
  return;
 }
  removeShowPoint(map);
  showPoint = closest;
  var i = get2DIndex(layers[selectedIndex].source.data.geometry.coordinates,closest)
  map.setPaintProperty(closest[0]+","+closest[1]+","+i, 'circle-radius', 4);

  document.getElementById("lastPoint").style.display = 'block';
  document.getElementById('lastPoint').innerHTML = `{ ${round(closest[0],6)}, ${round(closest[1],6)} }`;
  var pos = map.project(new mapboxgl.LngLat(closest[0], closest[1]));
  document.getElementById('lastPoint').style.left = `${pos.x-80}px`; // Add an offset for better visibility
  document.getElementById('lastPoint').style.top = `${pos.y -35}px`; // Add an offset for better visibility
  
}

if (clickOption==6){
  if (closest==null){
  return;
 }
  document.getElementById("tagPopupContainer").style.display = 'block'
  tagPoint= closest;
}

});

//const lng = e.lngLat.lng.toFixed(6); // Round the longitude to 6 decimal places
//const lat = e.lngLat.lat.toFixed(6); // Round the latitude to 6 decimal places

//function for when they enter a new trail modification
function createNew(){
    var fields = gatherFields();
    //if the entries were not valid gatherFields return a length 0 array
    if (fields.length ==0){
        return;
    }
    //check to see if name exists aka if the trail already exists
    if (validEnter(fields[7])){
        addlay(translate(fields[2],fields[3],reduce(JSON.parse(fields[6]).features[0].geometry.coordinates[0],fields[1],fields[0])),map,fields[7],fields[4]);
     }
    else{
        printError("This trail modifcation already exists");
    }
}

//if any of the toggle buttons are pressed it goes here and the event tells
//the function which button was pressed and that toggles is on or off
function toggle(event){
  removeShowPoint(map)
  removeMovePoint(map);
    var layerId = event.target.id.substring(0, event.target.id.length - 3);
    if (event.target.innerHTML=="Show"){
        event.target.textContent = "Hide";
        map.setLayoutProperty(layerId, 'visibility', 'visible');
        if (selected!=null && layerId == selected.id){
          addAllPoints(layers[search(layerId)].source.data.geometry.coordinates,map);
        }
    }
    else{
        map.setLayoutProperty(layerId, 'visibility', 'none');
        event.target.textContent = "Show";
        if (selected!=null && layerId == selected.id){
          removeAllPoints(layers[search(layerId)].source.data.geometry.coordinates,map);
        }
    }
}


function remove(event){
  removeShowPoint(map)
  removeMovePoint(map);
    var index = event.target.parentNode.parentNode.rowIndex-1;
    document.getElementById("datatable").deleteRow(index+1); //heading is 0th index
    map.removeLayer(layers[index].id);
    map.removeSource(layers[index].id);
    var coords = new Array(0);
       for (var i=0; i<layers[index].source.data.geometry.coordinates.length; i++){
        coords.push(layers[index].source.data.geometry.coordinates[i])
       }
    layers.splice(index,1);
    if (index<curIndex){
          curIndex-=1;
    }
    if (index ==selectedIndex){
      removeAllPoints(coords,map);
      selectedIndex=-1;
      selected=null;
      selectedPoints = new Array(0);
      updateVersionDisplay()
    }
    if (index<selectedIndex){
      selectedIndex-=1;
    }
}


function copy(event){
    var index = event.target.parentNode.parentNode.rowIndex-1;
    /*var props="[";
    for (var i=0;i<tags[index].length;i++){
      props+="[["+tags[index]     "[[x,y],p]"
    }*/
    var linestring = {
        "type": "Feature",
        "geometry": {
            "type": "LineString",
            "coordinates": layers[index].source.data.geometry.coordinates
        }
    };
    round(turf.lineDistance(linestring)*3280.84/5280,3);
    var props = "Tags: "+JSON.stringify(tags[index])+", Miles: "+round(turf.lineDistance(linestring)*3280.84/5280,3)+", Version: "+states[index].length;

    var jsonString = JSON.stringify(example).substring(0,110)+JSON.stringify(layers[index].source.data.geometry.coordinates)+JSON.stringify(example).substring(147,164)+props+JSON.stringify(example).substring(164)
    navigator.clipboard.writeText(jsonString)
      .then(function() {
        
      })
      .catch(function(error) {
        printError("Unable to Copy to Clip Board")
      });
}

//function to change which trail is selected
function changeSelected(event){
  removeShowPoint(map)
  removeMovePoint(map);
  selectedPoints = new Array(0);
  if (event.target.textContent == "Select"){
  var layerId = event.target.id.substring(0, event.target.id.length - 3);
  var layerIndex = search(layerId);
  var layer = layers[layerIndex];
  if (selected!=null){
    var coords = new Array(0);
       for (var i=0; i<selected.source.data.geometry.coordinates.length; i++){
        coords.push(selected.source.data.geometry.coordinates[i])
       }
  document.getElementById("datatable").rows[selectedIndex+1].cells[9].querySelector("button").textContent = "Select";
  if (map.getLayoutProperty(layers[selectedIndex].id, 'visibility')!='none'){
    removeAllPoints(coords,map);
  }
  }
  selected = layer;
  selectedIndex = layerIndex;
  document.getElementById("datatable").rows[layerIndex+1].cells[9].querySelector("button").textContent = "Unselect";
  coords = selected.source.data.geometry.coordinates;
  if (document.getElementById("datatable").rows[selectedIndex+1].cells[6].textContent =="Hide"){
    addAllPoints(coords,map)
  }
  
}
else{
  var coords = new Array(0);
       for (var i=0; i<selected.source.data.geometry.coordinates.length; i++){
        coords.push(selected.source.data.geometry.coordinates[i])
       }
       if (map.getLayoutProperty(layers[selectedIndex].id, 'visibility')!='none'){
        removeAllPoints(coords,map)
      }
 
  document.getElementById("datatable").rows[selectedIndex+1].cells[9].querySelector("button").textContent = "Select";
  selectedIndex =-1;
  selected = null;
}
updateVersionDisplay()
}




function addFilePopUp() {
    if (document.getElementById("file").value != "create"){
        return;
    }
  var popupContainer = document.getElementById("popupContainer");
  popupContainer.style.display = "block";
  var input = document.getElementById("enterGeo");
}

function cancelFilePopup() {
  document.getElementById("popupContainer").style.display = "none";
  document.getElementById("file").selectedIndex=0;
}

function submitFilePopup() {
  var popupContainer = document.getElementById("popupContainer");
  if (document.getElementById("geoName").value==""){
    printError("Enter Name: is empty");
    return;
  }
  try{
    var json = JSON.parse(document.getElementById("enterGeo").value);
    json.features[0].geometry.coordinates[0]
  }
  catch(error){
    printError("Not a valid GEOJSON. Here is a sample valid GEOJSON");
    document.getElementById("enterGeo").value = JSON.stringify(example);
    return;
  }
  var option = document.createElement("option");
  for (var i=0; i<document.getElementById("file").options.length-1; i++){
    if (document.getElementById("file").options[i].value == JSON.stringify(json)){
        printError("That GEOJSON already exists");
        return;
    }
    if (document.getElementById("file").options[i].textContent == document.getElementById("geoName").value){
        printError("That name already exists");
        return;
    }
  }
  option.value = JSON.stringify(json);
  option.text = document.getElementById("geoName").value;
  popupContainer.style.display = "none";
  document.getElementById("file").options.add(option,file.options.length-1);
  document.getElementById("file").selectedIndex = document.getElementById("file").selectedIndex-1;
  addlay(roundCoords(JSON.parse(option.value).features[0].geometry.coordinates[0],6),map,option.text+"_d--_a--_tx--_ty--_c#00f","#00f");
}

function openHistory(){
      document.getElementById("showVersions").style.display = 'block'
     // document.getElementById("showInfoDivText").innerHTML = runs[rowIndex-1][3];
    }

  function closeHistory(){
  document.getElementById("showVersions").style.display = "none";
  }

  function updateVersionDisplay(){
    var table = document.getElementById("versionsTable");

    // Remove all rows except the header row (index 0)
    while (table.rows.length > 1) {
      table.deleteRow(1);
    }
    console.log(table.rows)
    if (selected==null){
      console.log("nu")
      return;
    }

    for (var i=0; i<states[selectedIndex].length-1; i++){
      var newRow = table.insertRow();
      var cell = newRow.insertCell();
      cell.innerHTML = "Version "+(i+1);
      cell.addEventListener("click", showPreview);
      document.getElementById("showVersions").scrollTop = document.getElementById("showVersions").scrollHeight;
    }
  }

  function toggleTutorial() {

    if (document.getElementById('infoPopup').style.display=='block'){
        document.getElementById('infoPopup').style.display = 'none';
    }
    else{
        document.getElementById('infoPopup').style.display = 'block'; 
    }
    }

    function closeTutorial() {
      document.getElementById('infoPopup').style.display = 'none';
}
    
    
function promptClickToggle(){
    if (document.getElementById('clickTogglePopup').style.display=='block'){
        document.getElementById('clickTogglePopup').style.display = 'none';
    }
    else{
        document.getElementById('clickTogglePopup').style.display = 'block'; 
    }
}

function singleClick(){
  unselectAll();
  map.getCanvas().style.cursor = 'pointer';
  if (clickOption ==1){
    selectedPoints = new Array(0);
    document.getElementById("removeAll").style.display = 'none';
  }
  removeShowPoint(map)
  removeMovePoint(map);
  removeAddBeforePoint(map);
  
  clickOption = 0;
  document.getElementById("singleSelect").style.backgroundColor = "gray";
  document.getElementById("multiSelect").style.backgroundColor = 'rgb(233, 233, 237)';
  document.getElementById("move").style.backgroundColor = 'rgb(233, 233, 237)';
  document.getElementById("nothing").style.backgroundColor = 'rgb(233, 233, 237)';
  document.getElementById("merge").style.backgroundColor = 'rgb(233, 233, 237)';
  document.getElementById("lastPoint").style.display = 'none';
  document.getElementById("move").style.display = 'block';
  document.getElementById("moveSelect").style.display = 'none';
  document.getElementById("moveMove").style.display = 'none';
  document.getElementById("addSelect").style.display = 'none';
  document.getElementById("addAdd").style.display = 'none';
  document.getElementById("add").style.display = 'block';
  document.getElementById("addEnd").style.display = 'none';
  document.getElementById("addTag").style.backgroundColor = 'rgb(233, 233, 237)'
}

function multiSelect(){
  if (clickOption!=1){
    unselectAll();
  }
  map.getCanvas().style.cursor = 'pointer';
  removeShowPoint(map)
  removeMovePoint(map);
  removeAddBeforePoint(map);
  document.getElementById("removeAll").style.display = 'block';
  clickOption = 1;
  document.getElementById("singleSelect").style.backgroundColor = 'rgb(233, 233, 237)';
  document.getElementById("multiSelect").style.backgroundColor = "gray";
  document.getElementById("move").style.backgroundColor = 'rgb(233, 233, 237)';
  document.getElementById("nothing").style.backgroundColor = 'rgb(233, 233, 237)';
  document.getElementById("merge").style.backgroundColor = 'rgb(233, 233, 237)';
  document.getElementById("lastPoint").style.display = 'none';
  document.getElementById("move").style.display = 'block';
  document.getElementById("moveSelect").style.display = 'none';
  document.getElementById("moveMove").style.display = 'none';
  document.getElementById("addSelect").style.display = 'none';
  document.getElementById("addAdd").style.display = 'none';

  document.getElementById("add").style.display = 'block';
  document.getElementById("addEnd").style.display = 'none';
  document.getElementById("addTag").style.backgroundColor = 'rgb(233, 233, 237)'
}

function move(){
  unselectAll();
  map.getCanvas().style.cursor 
  removeShowPoint(map)
  removeAddBeforePoint(map);
  if (clickOption ==1){
    selectedPoints = new Array(0);
    document.getElementById("removeAll").style.display = 'none';
  }
  clickOption =2;
  moveOption =0;
  document.getElementById("singleSelect").style.backgroundColor = 'rgb(233, 233, 237)';
  document.getElementById("multiSelect").style.backgroundColor = 'rgb(233, 233, 237)';
  document.getElementById("nothing").style.backgroundColor = 'rgb(233, 233, 237)';
  document.getElementById("merge").style.backgroundColor = 'rgb(233, 233, 237)';
  document.getElementById("lastPoint").style.display = 'none';

  document.getElementById("move").style.display = 'none';
  document.getElementById("moveSelect").style.display = 'block';
  document.getElementById("moveMove").style.display = 'block';
  document.getElementById("moveSelect").style.backgroundColor = "gray";
  document.getElementById("moveMove").style.backgroundColor = 'rgb(233, 233, 237)';
  document.getElementById("addSelect").style.display = 'none';
  document.getElementById("addAdd").style.display = 'none';
  document.getElementById("add").style.display = 'block';
  document.getElementById("addEnd").style.display = 'none';
  document.getElementById("addTag").style.backgroundColor = 'rgb(233, 233, 237)'
}

function merge(){
  unselectAll();
  removeMovePoint(map);
  removeShowPoint(map)
  removeAddBeforePoint(map);
  map.getCanvas().style.cursor = 'pointer';
  if (clickOption ==1){
    selectedPoints = new Array(0);
    document.getElementById("removeAll").style.display = 'none';
  }
  document.getElementById("singleSelect").style.backgroundColor = 'rgb(233, 233, 237)';
  document.getElementById("multiSelect").style.backgroundColor ='rgb(233, 233, 237)';
  document.getElementById("move").style.backgroundColor = 'rgb(233, 233, 237)';
  document.getElementById("nothing").style.backgroundColor = 'rgb(233, 233, 237)';
  document.getElementById("merge").style.backgroundColor = "gray";
    document.getElementById("move").style.display = 'block';
  document.getElementById("moveSelect").style.display = 'none';
  document.getElementById("moveMove").style.display = 'none';
  document.getElementById("addSelect").style.display = 'none';
  document.getElementById("addAdd").style.display = 'none';
  document.getElementById("add").style.display = 'block';
  document.getElementById("addEnd").style.display = 'none';
  clickOption =3;
  document.getElementById("addTag").style.backgroundColor = 'rgb(233, 233, 237)'
}

function add(){
  unselectAll();
  map.getCanvas().style.cursor = 'pointer';
  removeMovePoint(map);
  removeShowPoint(map)
  if (clickOption ==1){
    selectedPoints = new Array(0);
    document.getElementById("removeAll").style.display = 'none';
  }
  clickOption = 5;
  addOption =0;
  document.getElementById("singleSelect").style.backgroundColor = 'rgb(233, 233, 237)';
  document.getElementById("multiSelect").style.backgroundColor ='rgb(233, 233, 237)';
  document.getElementById("move").style.backgroundColor = 'rgb(233, 233, 237)';
  document.getElementById("merge").style.backgroundColor = 'rgb(233, 233, 237)';
  document.getElementById("nothing").style.backgroundColor = 'rgb(233, 233, 237)';
  document.getElementById("add").style.display = 'none';
    document.getElementById("move").style.display = 'block';
  document.getElementById("moveSelect").style.display = 'none';
  document.getElementById("moveMove").style.display = 'none';
  document.getElementById("addSelect").style.display = 'block';
  document.getElementById("addSelect").style.backgroundColor = "gray";
  document.getElementById("addAdd").style.backgroundColor = 'rgb(233, 233, 237)';
  document.getElementById("addAdd").style.display = 'block';
  document.getElementById("addEnd").style.display = 'block';
  document.getElementById("addTag").style.backgroundColor = 'rgb(233, 233, 237)'
}



function addAdd(){
  if (addBeforePoint ==null){
    printError("No Point Selected To Add After");
    return;
  }
  document.getElementById("addAdd").style.backgroundColor = "gray";
  document.getElementById("addSelect").style.backgroundColor = 'rgb(233, 233, 237)';
  addOption =1;
}

function addSelect(){
  document.getElementById("addSelect").style.backgroundColor = "gray";
  document.getElementById("addAdd").style.backgroundColor = 'rgb(233, 233, 237)';
  addOption =0;
}

function addEnd(){
  if (document.getElementById("addEnd").textContent == "Current: Add Before"){
    document.getElementById("addEnd").textContent = "Current: Add After";
  }
  else{
    document.getElementById("addEnd").textContent = "Current: Add Before";
  }
}

function addTag(){
  unselectAll();
  map.getCanvas().style.cursor = 'pointer';
  if (clickOption ==1){
    selectedPoints = new Array(0);
    document.getElementById("removeAll").style.display = 'none';
  }
  removeShowPoint(map)
  removeMovePoint(map);
  removeAddBeforePoint(map);
  
  clickOption = 6;
  document.getElementById("singleSelect").style.backgroundColor = "rgb(233, 233, 237)";
  document.getElementById("multiSelect").style.backgroundColor = 'rgb(233, 233, 237)';
  document.getElementById("move").style.backgroundColor = 'rgb(233, 233, 237)';
  document.getElementById("nothing").style.backgroundColor = 'rgb(233, 233, 237)';
  document.getElementById("merge").style.backgroundColor = 'rgb(233, 233, 237)';
  document.getElementById("lastPoint").style.display = 'none';
  document.getElementById("move").style.display = 'block';
  document.getElementById("moveSelect").style.display = 'none';
  document.getElementById("moveMove").style.display = 'none';
  document.getElementById("addSelect").style.display = 'none';
  document.getElementById("addAdd").style.display = 'none';
  document.getElementById("add").style.display = 'block';
  document.getElementById("addEnd").style.display = 'none';
  document.getElementById("addTag").style.backgroundColor = 'gray'
}


function showClick(){
  unselectAll();
  map.getCanvas().style.cursor = 'pointer';
  removeMovePoint(map);
  removeAddBeforePoint(map);
  if (clickOption ==1){
    selectedPoints = new Array(0);
    document.getElementById("removeAll").style.display = 'none';
  }
  clickOption = 4;
  document.getElementById("singleSelect").style.backgroundColor = 'rgb(233, 233, 237)';
  document.getElementById("multiSelect").style.backgroundColor ='rgb(233, 233, 237)';
  document.getElementById("move").style.backgroundColor = 'rgb(233, 233, 237)';
  document.getElementById("merge").style.backgroundColor = 'rgb(233, 233, 237)';
  document.getElementById("nothing").style.backgroundColor = "gray";
    document.getElementById("move").style.display = 'block';
  document.getElementById("moveSelect").style.display = 'none';
  document.getElementById("moveMove").style.display = 'none';
  document.getElementById("addSelect").style.display = 'none';
  document.getElementById("addAdd").style.display = 'none';
  document.getElementById("add").style.display = 'block';
  document.getElementById("addEnd").style.display = 'none';
  document.getElementById("addTag").style.backgroundColor = 'rgb(233, 233, 237)'
}


function moveMove(){
  map.getCanvas().style.cursor = 'crosshair';
  if (movePoint ==null){
    printError("No Point Selected To Move");
    return;
  }
  document.getElementById("moveMove").style.backgroundColor = "gray";
  document.getElementById("moveSelect").style.backgroundColor = 'rgb(233, 233, 237)';
  moveOption =1;
}

function moveSelect(){
  map.getCanvas().style.cursor = 'pointer';
  document.getElementById("moveSelect").style.backgroundColor = "gray";
  document.getElementById("moveMove").style.backgroundColor = 'rgb(233, 233, 237)';
  moveOption =0;
}


function unselectAll(){
  for (var i=0; i<selectedPoints.length; i++){
    var j = get2DIndex(layers[selectedIndex].source.data.geometry.coordinates,selectedPoints[i])
    map.setPaintProperty(selectedPoints[i][0]+","+selectedPoints[i][1]+","+j, 'circle-radius', [
                  'interpolate',
                  ['linear'],
                  ['zoom'],
                  15, .5, 
                  16, 1,
                  17.5,2.5
                ]);
  }
  selectedPoints = new Array(0)
}



//helper function to print an error message
function printError(message){
    var errorMessage = document.getElementById('error-message');
  errorMessage.innerText = message;
  errorMessage.style.display = 'block';

  setTimeout(function() {
    errorMessage.style.display = 'none';
  }, 3000); // Display for 3 seconds (3000 milliseconds)
}

  var popup = document.getElementById('versionPopupContainer');
    var newMap;

    function showPreview(event) {
      var clickedRow = event.target.parentElement;
    undoIndex = Array.from(clickedRow.parentNode.children).indexOf(clickedRow)-1;
      popup.style.display = 'block';
      newMap = createNestedMap()
      newMap.on('load', function() {
        newMap.addLayer({
        "id": "showing",
        "type": "line",
        "source": {
            "type": "geojson",
            "data": {
                "type": "Feature",
                "properties": {},
                "geometry": {
                    "type": "LineString",
                    "coordinates": states[selectedIndex][undoIndex]
                }
            }
        },

        "layout": {
            "line-join": "round",
            "line-cap": "round"
        },
        "paint": {
            "line-color": "blue",
            "line-width": 3
        }
    });
    addAllPoints(states[selectedIndex][undoIndex],newMap);
    document.getElementById("versionNumber").innerHTML = "Version: "+(undoIndex+1);
}
);
    }

    function reshowPreview() {
      document.getElementById("versionNumber").innerHTML = "Version: "+(undoIndex+1);
      var newMap = createNestedMap()
      newMap.on('load', function() {
        newMap.addLayer({
        "id": "showing",
        "type": "line",
        "source": {
            "type": "geojson",
            "data": {
                "type": "Feature",
                "properties": {},
                "geometry": {
                    "type": "LineString",
                    "coordinates": states[selectedIndex][undoIndex]
                }
            }
        },

        "layout": {
            "line-join": "round",
            "line-cap": "round"
        },
        "paint": {
            "line-color": "blue",
            "line-width": 3
        }
    });
    addAllPoints(states[selectedIndex][undoIndex],newMap);
}
);
    }

    
function restore(){
  restored=true;
  showClick()
  removeAllPoints(selected.source.data.geometry.coordinates,map)
  layers[selectedIndex].source.data.geometry.coordinates = states[selectedIndex][undoIndex]
    states[selectedIndex].splice(undoIndex+1)
    tags[selectedIndex] = tagStates[selectedIndex][undoIndex]
    tagStates[selectedIndex].splice(undoIndex+1)
  selected = layers[selectedIndex]
  map.removeLayer(window.selected.id);
  map.removeSource(window.selected.id);
  map.addLayer(window.selected);
  addAllPoints(selected.source.data.geometry.coordinates,map)
  editPercentage()
  editLength()
  updateVersionDisplay()
  closePreview()
}

  
    


    function createNestedMap() {
    var nestedMap = new mapboxgl.Map({
        container: 'nestedMap', // Use the nestedMap div as the container
        style: 'mapbox://styles/mapbox/light-v10',
        center: [-70.052, 41.9887], // Replace lng and lat with the desired center coordinates
        zoom: 16 // Adjust the zoom level as needed
    });
    return nestedMap;
}
    function closePreview() {
      popup.style.display = 'none';
    }

    function closeTag(){
      document.getElementById("tagPopupContainer").style.display = 'none'
    }

</script>
 
</body>
</html>
